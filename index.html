<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, interactive-widget=resizes-content">
<meta name="theme-color" content="#0a0a0a">
<title>Ты не случаен</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  width: 100%; height: 100dvh; overflow: hidden;
  background: #0a0a0a; color: #e0e0e0;
  font-family: 'JetBrains Mono', monospace;
  -webkit-tap-highlight-color: transparent;
  overscroll-behavior: none;
}
body { padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }

#app { width: 100%; height: 100%; position: relative; }

.screen {
  position: absolute; inset: 0;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 200ms ease;
}
.screen.active { opacity: 1; pointer-events: auto; }

/* ===== WELCOME ===== */
#welcome { padding: 2rem; text-align: center; gap: 1.5rem; }
#welcome h1 { font-size: 2.4rem; font-weight: 700; color: #fff; letter-spacing: -0.03em; line-height: 1.1; }
#welcome .subtitle { font-size: 1rem; color: #00ff88; font-weight: 700; }
#welcome .rules {
  font-size: 1rem; color: #ccc; line-height: 2; max-width: 340px;
}
#welcome .rules strong { color: #fff; }
#welcome .rules .lose { color: #ff2244; font-weight: 700; }
#welcome .rules .win { color: #00ff88; font-weight: 700; }
#welcome .desc-small { font-size: 0.75rem; color: #555; line-height: 1.6; max-width: 300px; }

.btn-start {
  background: #00ff88; color: #0a0a0a; border: none;
  padding: 1.1rem 3.5rem; font-family: 'JetBrains Mono', monospace;
  font-size: 1.15rem; font-weight: 700; border-radius: 10px; cursor: pointer;
  animation: pulse-glow 2s ease-in-out infinite; transition: transform 100ms ease;
}
.btn-start:active { transform: scale(0.96); }

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
  50% { box-shadow: 0 0 40px rgba(0, 255, 136, 0.6); }
}

.welcome-footer {
  font-size: 0.9rem; color: #666;
}
.welcome-footer a { color: #888; text-decoration: none; border-bottom: 1px solid #555; }
.welcome-footer a:hover { color: #ccc; }

/* ===== GAME ===== */
#game { user-select: none; touch-action: manipulation; cursor: pointer; }

.water-bg {
  position: absolute; bottom: 0; left: 0; right: 0; height: 100%;
  background: rgba(0, 255, 136, 0.15);
  transition: height 300ms ease-out, background-color 500ms ease;
  pointer-events: none; z-index: 0;
}
.game-divider {
  position: absolute; top: 0; bottom: 0; left: 50%; width: 1px;
  background: rgba(255,255,255,0.08); z-index: 1; pointer-events: none;
}
.zone-label {
  position: absolute; top: 50%; transform: translateY(-50%);
  font-size: 1.5rem; color: rgba(255,255,255,0.06); z-index: 1; pointer-events: none;
}
.zone-label.left { left: calc(25% - 0.5em); }
.zone-label.right { right: calc(25% - 0.5em); }

.game-hud {
  position: absolute; top: 0; left: 0; right: 0; z-index: 2; pointer-events: none;
  display: flex; flex-direction: column; align-items: center; padding-top: 3rem; gap: 0.25rem;
}
.hud-level { font-size: 0.7rem; color: #555; letter-spacing: 0.05em; }
.hud-balance { font-size: 2.5rem; font-weight: 700; color: #e0e0e0; }
.hud-prediction-result {
  font-size: 1.5rem; opacity: 0; transition: opacity 150ms ease;
  height: 2rem; display: flex; align-items: center; justify-content: center;
}
.hud-prediction-result.correct { color: #ff2244; }
.hud-prediction-result.wrong { color: #00ff88; }
.hud-prediction-result.show { opacity: 1; }

.hud-bottom {
  position: absolute; bottom: 1.5rem; left: 0; right: 0;
  text-align: center; z-index: 2; pointer-events: none;
  font-size: 1rem; font-weight: 700; color: #555;
}

.btn-stop {
  position: absolute; top: 1rem; right: 1rem; z-index: 3;
  background: transparent; border: 1px solid rgba(255,255,255,0.15);
  color: rgba(255,255,255,0.3); font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem; padding: 0.4rem 0.8rem; border-radius: 4px;
  cursor: pointer; transition: opacity 200ms;
}
.btn-stop:disabled { opacity: 0; pointer-events: none; }
.btn-stop:hover:not(:disabled) { color: rgba(255,255,255,0.6); border-color: rgba(255,255,255,0.3); }

.ripple {
  position: absolute; border-radius: 50%; background: rgba(255,255,255,0.15);
  transform: scale(0); animation: ripple-anim 400ms ease-out forwards;
  pointer-events: none; z-index: 1;
}
@keyframes ripple-anim { to { transform: scale(1); opacity: 0; } }

/* ===== RESULT ===== */
#result {
  padding: 2rem 1.5rem; text-align: center; overflow-y: auto;
  justify-content: flex-start; padding-top: 3rem; gap: 1rem;
}
#result h2 { font-size: 1.4rem; font-weight: 700; line-height: 1.3; }
.result-balance { font-size: 2.2rem; font-weight: 700; }

.result-stats { width: 100%; max-width: 340px; text-align: left; font-size: 0.8rem; color: #999; line-height: 1.8; }
.result-stats span { color: #e0e0e0; }

.balance-graph-container { width: 100%; max-width: 340px; }
.balance-graph-label { font-size: 0.7rem; color: #555; text-align: left; margin-bottom: 0.3rem; }
.balance-graph {
  width: 100%; height: 80px; border-radius: 6px; overflow: hidden;
  background: #111; border: 1px solid #222;
}

.pattern-map-container { width: 100%; max-width: 340px; display: flex; flex-direction: column; gap: 0.3rem; }
.pattern-map-label { font-size: 0.7rem; color: #555; text-align: left; }
.pattern-map { display: flex; flex-wrap: wrap; gap: 1px; }
.pattern-map .cell { width: 6px; height: 6px; border-radius: 1px; }

.result-buttons { display: flex; flex-direction: column; gap: 0.75rem; width: 100%; max-width: 280px; margin-top: 0.5rem; }

.btn-primary {
  background: #00ff88; color: #0a0a0a; border: none; padding: 0.9rem 2rem;
  font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700;
  border-radius: 8px; cursor: pointer; transition: transform 100ms;
}
.btn-primary:active { transform: scale(0.96); }
.btn-secondary {
  background: transparent; color: #999; border: 1px solid #333; padding: 0.8rem 2rem;
  font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; border-radius: 8px;
  cursor: pointer; transition: transform 100ms;
}
.btn-secondary:active { transform: scale(0.96); }

/* ===== THEORY (single scroll) ===== */
#theory {
  padding: 1.5rem; padding-bottom: 3rem; overflow-y: auto;
  justify-content: flex-start; align-items: stretch; gap: 0;
}
.theory-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
.theory-header h2 { font-size: 1.3rem; font-weight: 700; }
.btn-back {
  background: transparent; border: 1px solid #333; color: #999;
  font-family: 'JetBrains Mono', monospace; font-size: 0.75rem;
  padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer;
}

.theory-body { font-size: 0.88rem; line-height: 1.7; color: #ccc; }
.theory-body p { margin-bottom: 1rem; }
.theory-body strong { color: #e0e0e0; }
.theory-body a { color: #00ff88; text-decoration: none; border-bottom: 1px solid rgba(0,255,136,0.3); transition: border-color 150ms; }
.theory-body a:hover { border-color: #00ff88; }
.theory-body ul { padding-left: 1.2rem; margin-bottom: 1rem; }
.theory-body li { margin-bottom: 0.4rem; }

.theory-body .formula {
  background: #111; border: 1px solid #222; border-radius: 6px;
  padding: 0.8rem 1rem; margin: 0.8rem 0; font-size: 0.8rem; color: #aaa; overflow-x: auto;
}
.theory-body .example-box {
  background: #111; border-left: 3px solid #00ff88; padding: 0.8rem 1rem;
  margin: 0.8rem 0; font-size: 0.82rem; color: #bbb; line-height: 1.6;
}
.theory-body .example-box strong { color: #00ff88; }

.theory-divider {
  border: none; border-top: 1px solid #222; margin: 1.5rem 0;
}
.theory-section-title {
  font-size: 1rem; font-weight: 700; color: #e0e0e0; margin-bottom: 1rem;
}
.theory-play-btn { align-self: center; margin: 1.5rem 0; }

.author-link {
  margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #1a1a1a;
  text-align: center; font-size: 0.9rem; color: #666;
}
.author-link a { color: #888; text-decoration: none; border-bottom: 1px solid #555; }
.author-link a:hover { color: #ccc; }

/* ===== LEVEL BADGE ===== */
.level-badge {
  display: inline-block; padding: 0.2rem 0.6rem; border-radius: 4px;
  font-size: 0.7rem; font-weight: 700; letter-spacing: 0.05em;
}
.level-badge.l1 { border: 1px solid #00ff88; color: #00ff88; }
.level-badge.l2 { border: 1px solid #ffcc00; color: #ffcc00; }
.level-badge.l3 { border: 1px solid #ff8800; color: #ff8800; }
.level-badge.l4 { border: 1px solid #ff2244; color: #ff2244; }
.level-badge.l5 { border: 1px solid #cc44ff; color: #cc44ff; }

.result-level-up {
  background: rgba(0,255,136,0.08); border: 1px solid rgba(0,255,136,0.3);
  border-radius: 8px; padding: 1rem; text-align: center; width: 100%; max-width: 340px;
}
.result-level-up .level-up-title { font-size: 1rem; font-weight: 700; color: #00ff88; margin-bottom: 0.3rem; }
.result-level-up .level-up-desc { font-size: 0.75rem; color: #999; }

.btn-next-level {
  background: #ffcc00; color: #0a0a0a; border: none; padding: 0.9rem 2rem;
  font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700;
  border-radius: 8px; cursor: pointer; transition: transform 100ms;
}
.btn-next-level:active { transform: scale(0.96); }
.btn-next-level.final { background: #cc44ff; color: #fff; }

.fade-item { opacity: 0; transform: translateY(10px); animation: fade-up 300ms ease forwards; }
@keyframes fade-up { to { opacity: 1; transform: translateY(0); } }

.btn-lang {
  position: absolute; top: 1rem; right: 1rem; z-index: 10;
  background: transparent; border: 1px solid #555; color: #888;
  font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; font-weight: 700;
  padding: 0.35rem 0.7rem; border-radius: 4px; cursor: pointer;
  letter-spacing: 0.05em;
  animation: lang-pulse 2s ease-in-out infinite;
}
.btn-lang:hover { color: #fff; border-color: #888; }
@keyframes lang-pulse {
  0%, 100% { border-color: #555; color: #888; }
  50% { border-color: #00ff88; color: #00ff88; }
}

/* ===== RESULT CARD (shareable) ===== */
.result-card {
  background: #111; border: 1px solid #222; border-radius: 16px;
  padding: 2rem 1.5rem; width: 100%; max-width: 380px;
  display: flex; flex-direction: column; align-items: center; gap: 0.8rem;
}
.result-card-title {
  font-size: 0.85rem; font-weight: 700; color: #555;
  letter-spacing: 0.08em; text-transform: uppercase;
}
.result-level-badge-big {
  display: inline-block; padding: 0.5rem 1.2rem; border-radius: 8px;
  font-size: 1.1rem; font-weight: 700; letter-spacing: 0.08em;
}
.result-level-badge-big.l1 { border: 2px solid #00ff88; color: #00ff88; }
.result-level-badge-big.l2 { border: 2px solid #ffcc00; color: #ffcc00; }
.result-level-badge-big.l3 { border: 2px solid #ff8800; color: #ff8800; }
.result-level-badge-big.l4 { border: 2px solid #ff2244; color: #ff2244; }
.result-level-badge-big.l5 { border: 2px solid #cc44ff; color: #cc44ff; }
.result-balance-big { font-size: 2.8rem; font-weight: 700; line-height: 1; }

/* ===== ENDGAME (Level 5 complete) ===== */
.endgame-card {
  background: linear-gradient(135deg, rgba(204,68,255,0.12) 0%, rgba(0,255,136,0.08) 100%);
  border: 2px solid #cc44ff; border-radius: 16px;
  padding: 2.5rem 2rem; width: 100%; max-width: 380px;
  display: flex; flex-direction: column; align-items: center; gap: 1rem; text-align: center;
}
.endgame-title {
  font-size: 0.85rem; font-weight: 700; color: #888;
  letter-spacing: 0.08em; text-transform: uppercase;
}
.endgame-badge {
  font-size: 1.8rem; font-weight: 700; color: #cc44ff;
  text-shadow: 0 0 30px rgba(204,68,255,0.5);
}
.endgame-message { font-size: 1.5rem; font-weight: 700; color: #fff; line-height: 1.3; }
.endgame-sub { font-size: 0.85rem; color: #999; line-height: 1.6; }
.endgame-balance { font-size: 2.2rem; font-weight: 700; color: #00ff88; }

.result-author { font-size: 0.85rem; color: #666; margin-top: 0.3rem; }
.result-author a { color: #888; text-decoration: none; border-bottom: 1px solid #555; }
.result-author a:hover { color: #ccc; }
</style>
</head>
<body>
<div id="app">

  <!-- WELCOME -->
  <div id="welcome" class="screen active">
    <button class="btn-lang" id="btnLang">EN</button>
    <h1 id="welTitle"></h1>
    <p class="subtitle" id="welSubtitle"></p>
    <div class="rules" id="welRules"></div>
    <button class="btn-start" id="btnStart"></button>
    <p class="desc-small" id="welHint"></p>
    <div class="welcome-footer" id="welFooter"></div>
  </div>

  <!-- GAME -->
  <div id="game" class="screen">
    <div class="water-bg" id="waterBg"></div>
    <div class="game-divider"></div>
    <div class="zone-label left">0</div>
    <div class="zone-label right">1</div>
    <div class="game-hud">
      <div class="hud-level" id="hudLevel"></div>
      <div class="hud-balance" id="hudBalance">$15.00</div>
      <div class="hud-prediction-result" id="hudPredResult"></div>
    </div>
    <div class="hud-bottom" id="hudCounter">0/40</div>
    <button class="btn-stop" id="btnStop" disabled></button>
  </div>

  <!-- RESULT -->
  <div id="result" class="screen"></div>

  <!-- THEORY -->
  <div id="theory" class="screen"></div>

</div>

<script>
'use strict';

// ===== i18n =====
const LANG = {
  ru: {
    title: '\u0422\u044b \u043d\u0435 \u0441\u043b\u0443\u0447\u0430\u0435\u043d',
    subtitle: '\u041f\u043e\u043f\u0440\u043e\u0431\u0443\u0439 \u043e\u0431\u044b\u0433\u0440\u0430\u0442\u044c \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c',
    rulesHTML: '\u041d\u0430\u0436\u0438\u043c\u0430\u0439 <strong>\u043b\u0435\u0432\u043e</strong> \u0438 <strong>\u043f\u0440\u0430\u0432\u043e</strong> \u0432 \u0441\u043b\u0443\u0447\u0430\u0439\u043d\u043e\u043c \u043f\u043e\u0440\u044f\u0434\u043a\u0435.<br>\u0410\u043b\u0433\u043e\u0440\u0438\u0442\u043c \u043f\u0440\u0435\u0434\u0441\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442 \u043a\u0430\u0436\u0434\u043e\u0435 \u043d\u0430\u0436\u0430\u0442\u0438\u0435.<br><br>\u0423\u0433\u0430\u0434\u0430\u043b \u2014 <span class="lose">\u0442\u044b \u0442\u0435\u0440\u044f\u0435\u0448\u044c $1</span><br>\u041d\u0435 \u0443\u0433\u0430\u0434\u0430\u043b \u2014 <span class="win">\u0442\u044b \u043f\u043e\u043b\u0443\u0447\u0430\u0435\u0448\u044c $1.10</span>',
    play: '\u0418\u0433\u0440\u0430\u0442\u044c',
    stop: '\u0421\u0442\u043e\u043f',
    hint: '\u041d\u0430 \u043a\u043e\u043c\u043f\u044c\u044e\u0442\u0435\u0440\u0435: \u0441\u0442\u0440\u0435\u043b\u043a\u0438 \u2190 \u2192',
    level: '\u0423\u0420\u041e\u0412\u0415\u041d\u042c',
    levelName: '\u0423\u0440\u043e\u0432\u0435\u043d\u044c',
    won: '\u0422\u044b \u043e\u0431\u044b\u0433\u0440\u0430\u043b \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c!',
    wonBarely: '\u041f\u043e\u0431\u0435\u0434\u0430 \u043d\u0430 \u0433\u0440\u0430\u043d\u0438!',
    predictable70: '\u0422\u044b \u043f\u043e\u043b\u043d\u043e\u0441\u0442\u044c\u044e \u043f\u0440\u0435\u0434\u0441\u043a\u0430\u0437\u0443\u0435\u043c',
    predictable60: '\u0410\u043b\u0433\u043e\u0440\u0438\u0442\u043c \u0447\u0438\u0442\u0430\u0435\u0442 \u0442\u0435\u0431\u044f',
    almost55: '\u041f\u043e\u0447\u0442\u0438, \u043d\u043e \u043d\u0435 \u0441\u043b\u0443\u0447\u0430\u0439\u043d\u043e',
    lostSoClose: '\u0422\u0430\u043a \u0431\u043b\u0438\u0437\u043a\u043e!',
    impressive50: '\u0412\u043f\u0435\u0447\u0430\u0442\u043b\u044f\u044e\u0449\u0435!',
    incredible: '\u041d\u0435\u0432\u0435\u0440\u043e\u044f\u0442\u043d\u043e!',
    guessed: '\u0423\u0433\u0430\u0434\u0430\u043d\u043e',
    of: '\u0438\u0437',
    leftRight: '\u041b\u0435\u0432\u043e/\u043f\u0440\u0430\u0432\u043e',
    graphLabel: '\u041a\u0430\u043a \u043c\u0435\u043d\u044f\u043b\u0441\u044f \u0431\u0430\u043b\u0430\u043d\u0441',
    yourPresses: '\u0422\u0432\u043e\u0438 \u043d\u0430\u0436\u0430\u0442\u0438\u044f',
    predictions: '\u041f\u0440\u0435\u0434\u0441\u043a\u0430\u0437\u0430\u043d\u0438\u044f \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c\u0430',
    retry: '\u0415\u0449\u0451 \u0440\u0430\u0437',
    replayLevel: '\u041f\u0435\u0440\u0435\u0438\u0433\u0440\u0430\u0442\u044c',
    howItWorks: '\u041a\u0430\u043a \u044d\u0442\u043e \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442?',
    unlocked: '\u041e\u0442\u043a\u0440\u044b\u0442',
    pressesWord: '\u043d\u0430\u0436\u0430\u0442\u0438\u0439',
    atStart: '\u043d\u0430 \u0441\u0442\u0430\u0440\u0442\u0435',
    allLevels: '\u0412\u0441\u0435 \u0443\u0440\u043e\u0432\u043d\u0438 \u043f\u0440\u043e\u0439\u0434\u0435\u043d\u044b!',
    allLevelsDesc: '\u0422\u044b \u043f\u0440\u043e\u0448\u0451\u043b \u0432\u0441\u0435 \u043f\u044f\u0442\u044c \u0443\u0440\u043e\u0432\u043d\u0435\u0439.',
    finalBalance: '\u0424\u0438\u043d\u0430\u043b\u044c\u043d\u044b\u0439 \u0431\u0430\u043b\u0430\u043d\u0441',
    shareTitle: '\u0422\u044b \u043d\u0435 \u0441\u043b\u0443\u0447\u0430\u0435\u043d',
    gameComplete: '\u0422\u044b \u0434\u043e\u043a\u0430\u0437\u0430\u043b: \u0442\u044b \u0441\u043b\u0443\u0447\u0430\u0435\u043d',
    provedRandom: '\u0422\u044b \u043f\u0440\u043e\u0448\u0451\u043b \u0432\u0441\u0435 5 \u0443\u0440\u043e\u0432\u043d\u0435\u0439 \u0438 \u043e\u0431\u044b\u0433\u0440\u0430\u043b \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c.',
    theoryTitle: '\u041a\u0430\u043a \u044d\u0442\u043e \u0440\u0430\u0431\u043e\u0442\u0430\u0435\u0442?',
    back: '\u041d\u0430\u0437\u0430\u0434',
    playAgain: '\u0418\u0433\u0440\u0430\u0442\u044c \u0441\u043d\u043e\u0432\u0430',
    author: '\u0414\u0435\u043c\u043e\u043d\u0441\u0442\u0440\u0430\u0446\u0438\u044f',
    // theory
    t1title: '\u0428\u0430\u0433 \u0437\u0430 \u0448\u0430\u0433\u043e\u043c',
    t1p1: '\u0410\u043b\u0433\u043e\u0440\u0438\u0442\u043c \u0437\u0430\u043f\u0438\u0441\u044b\u0432\u0430\u0435\u0442 \u043a\u0430\u0436\u0434\u043e\u0435 \u043d\u0430\u0436\u0430\u0442\u0438\u0435. \u041f\u043e\u0441\u043b\u0435 10: <strong>\u041b \u041f \u041b \u041b \u041f \u041b \u041f \u041f \u041b \u041f</strong>. \u041e\u043d \u0438\u0449\u0435\u0442 \u0437\u0430\u043a\u043e\u043d\u043e\u043c\u0435\u0440\u043d\u043e\u0441\u0442\u0438.',
    t1ex1: '<strong>\u041f\u0440\u0438\u043c\u0435\u0440.</strong> \u0422\u044b \u0442\u0440\u0438 \u0440\u0430\u0437\u0430 \u043d\u0430\u0436\u0430\u043b \u00ab\u043b\u0435\u0432\u043e-\u043f\u0440\u0430\u0432\u043e\u00bb \u0438 \u043a\u0430\u0436\u0434\u044b\u0439 \u0440\u0430\u0437 \u043f\u043e\u0442\u043e\u043c \u2014 \u00ab\u043b\u0435\u0432\u043e\u00bb. \u0410\u043b\u0433\u043e\u0440\u0438\u0442\u043c \u0437\u0430\u043f\u043e\u043c\u043d\u0438\u043b. \u0421\u043b\u0435\u0434\u0443\u044e\u0449\u0438\u0439 \u0440\u0430\u0437 \u043f\u043e\u0441\u043b\u0435 \u00ab\u043b\u0435\u0432\u043e-\u043f\u0440\u0430\u0432\u043e\u00bb \u2014 \u043e\u043d \u0441\u0442\u0430\u0432\u0438\u0442 \u043d\u0430 \u00ab\u043b\u0435\u0432\u043e\u00bb.',
    t1p2: '\u0414\u043b\u044f \u043a\u0430\u0436\u0434\u043e\u0439 \u043a\u043e\u043c\u0431\u0438\u043d\u0430\u0446\u0438\u0438 \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0445 \u043d\u0430\u0436\u0430\u0442\u0438\u0439 \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c \u0441\u0447\u0438\u0442\u0430\u0435\u0442: \u0441\u043a\u043e\u043b\u044c\u043a\u043e \u0440\u0430\u0437 \u043f\u043e\u0441\u043b\u0435 \u043d\u0435\u0451 \u0431\u044b\u043b\u043e \u00ab\u043b\u0435\u0432\u043e\u00bb, \u0441\u043a\u043e\u043b\u044c\u043a\u043e \u00ab\u043f\u0440\u0430\u0432\u043e\u00bb. \u0427\u0435\u043c \u0431\u043e\u043b\u044c\u0448\u0435 \u0434\u0430\u043d\u043d\u044b\u0445 \u2014 \u0442\u0435\u043c \u0442\u043e\u0447\u043d\u0435\u0435.',
    t1p3: '\u041e\u0434\u043d\u043e\u0432\u0440\u0435\u043c\u0435\u043d\u043d\u043e \u0440\u0430\u0431\u043e\u0442\u0430\u044e\u0442 <strong>\u043d\u0435\u0441\u043a\u043e\u043b\u044c\u043a\u043e \u043c\u043e\u0434\u0435\u043b\u0435\u0439 \u0440\u0430\u0437\u043d\u043e\u0439 \u0433\u043b\u0443\u0431\u0438\u043d\u044b</strong>. \u0423\u0440\u043e\u0432\u0435\u043d\u044c 1 \u2014 \u0434\u043e 3 \u043d\u0430\u0436\u0430\u0442\u0438\u0439 \u043d\u0430\u0437\u0430\u0434. \u0423\u0440\u043e\u0432\u0435\u043d\u044c 2 \u2014 \u0434\u043e 4. \u0423\u0440\u043e\u0432\u0435\u043d\u044c 3 \u2014 \u0434\u043e 5. \u041a \u0443\u0440\u043e\u0432\u043d\u044e 5 \u2014 \u0434\u043e 7. \u0412\u0441\u0435 \u00ab\u0433\u043e\u043b\u043e\u0441\u0443\u044e\u0442\u00bb, \u043f\u043e\u0431\u0435\u0436\u0434\u0430\u0435\u0442 \u043a\u043e\u043d\u0441\u0435\u043d\u0441\u0443\u0441.',
    t1p4: '<strong>\u041d\u0435\u043f\u0440\u0435\u0440\u044b\u0432\u043d\u044b\u0439 \u044d\u043a\u0441\u043f\u0435\u0440\u0438\u043c\u0435\u043d\u0442.</strong> \u0411\u0430\u043b\u0430\u043d\u0441 \u0438 \u043f\u0430\u043c\u044f\u0442\u044c \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c\u0430 \u043f\u0435\u0440\u0435\u043d\u043e\u0441\u044f\u0442\u0441\u044f \u043c\u0435\u0436\u0434\u0443 \u0443\u0440\u043e\u0432\u043d\u044f\u043c\u0438. \u0417\u0430\u043a\u043e\u043d\u0447\u0438\u043b \u0443\u0440\u043e\u0432\u0435\u043d\u044c 1 \u0441 $18 \u2014 \u043d\u0430\u0447\u0438\u043d\u0430\u0435\u0448\u044c \u0443\u0440\u043e\u0432\u0435\u043d\u044c 2 \u0441 $18. \u041d\u043e \u0438 \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c \u043f\u043e\u043c\u043d\u0438\u0442 \u0432\u0441\u0435 \u0442\u0432\u043e\u0438 \u043f\u0440\u0438\u0432\u044b\u0447\u043a\u0438.',
    t1p5: '<strong>\u042d\u043a\u043e\u043d\u043e\u043c\u0438\u043a\u0430.</strong> \u0417\u0430 \u043f\u0440\u043e\u043c\u0430\u0445 \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c \u043f\u043b\u0430\u0442\u0438\u0442 $1.10, \u0437\u0430 \u0443\u0433\u0430\u0434\u044b\u0432\u0430\u043d\u0438\u0435 \u0437\u0430\u0431\u0438\u0440\u0430\u0435\u0442 $1. \u0415\u0441\u043b\u0438 \u0431\u044b \u0442\u044b \u0431\u044b\u043b \u0438\u0434\u0435\u0430\u043b\u044c\u043d\u043e \u0441\u043b\u0443\u0447\u0430\u0439\u043d\u044b\u043c \u2014 \u0442\u044b \u0431\u044b \u0437\u0430\u0440\u0430\u0431\u0430\u0442\u044b\u0432\u0430\u043b. \u041d\u043e \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c \u0443\u0433\u0430\u0434\u044b\u0432\u0430\u0435\u0442 \u0431\u043e\u043b\u044c\u0448\u0435 52%, \u0438 \u044d\u0442\u043e\u0433\u043e \u0445\u0432\u0430\u0442\u0430\u0435\u0442.',
    t2title: '\u041f\u043e\u0447\u0435\u043c\u0443 \u0442\u044b \u043f\u0440\u043e\u0438\u0433\u0440\u044b\u0432\u0430\u0435\u0448\u044c',
    t2p1: '\u041b\u044e\u0434\u0438 \u043f\u0443\u0442\u0430\u044e\u0442 \u0441\u043b\u0443\u0447\u0430\u0439\u043d\u043e\u0441\u0442\u044c \u0441 \u0447\u0435\u0440\u0435\u0434\u043e\u0432\u0430\u043d\u0438\u0435\u043c. \u00ab\u041b\u0435\u0432\u043e-\u043f\u0440\u0430\u0432\u043e-\u043b\u0435\u0432\u043e-\u043f\u0440\u0430\u0432\u043e\u00bb \u043a\u0430\u0436\u0435\u0442\u0441\u044f \u0441\u043b\u0443\u0447\u0430\u0439\u043d\u044b\u043c, \u043d\u043e \u043d\u0430\u0441\u0442\u043e\u044f\u0449\u0430\u044f \u0441\u043b\u0443\u0447\u0430\u0439\u043d\u043e\u0441\u0442\u044c \u2014 \u044d\u0442\u043e \u043a\u043e\u0433\u0434\u0430 \u0431\u044b\u0432\u0430\u0435\u0442 4\u20135 \u043e\u0434\u0438\u043d\u0430\u043a\u043e\u0432\u044b\u0445 \u043f\u043e\u0434\u0440\u044f\u0434.',
    t2li1: '<strong><a href="https://en.wikipedia.org/wiki/Gambler%27s_fallacy" target="_blank">\u0417\u0430\u0431\u043b\u0443\u0436\u0434\u0435\u043d\u0438\u0435 \u0438\u0433\u0440\u043e\u043a\u0430</a></strong> \u2014 \u043f\u043e\u0441\u043b\u0435 \u0442\u0440\u0451\u0445 \u00ab\u043b\u0435\u0432\u043e\u00bb \u043a\u0430\u0436\u0435\u0442\u0441\u044f, \u0447\u0442\u043e \u043f\u043e\u0440\u0430 \u043d\u0430\u0436\u0430\u0442\u044c \u00ab\u043f\u0440\u0430\u0432\u043e\u00bb. \u041c\u043e\u043d\u0435\u0442\u043a\u0435 \u0432\u0441\u0451 \u0440\u0430\u0432\u043d\u043e.',
    t2li2: '<strong>\u0421\u0442\u0440\u0430\u0445 \u0441\u0435\u0440\u0438\u0439</strong> \u2014 4 \u043f\u043e\u0434\u0440\u044f\u0434 \u043a\u0430\u0436\u0443\u0442\u0441\u044f \u043d\u0435\u0441\u043b\u0443\u0447\u0430\u0439\u043d\u044b\u043c\u0438. \u041d\u043e \u043f\u0440\u0438 100 \u0431\u0440\u043e\u0441\u043a\u0430\u0445 \u0441\u0435\u0440\u0438\u044f 4+ \u043f\u043e\u0447\u0442\u0438 \u0433\u0430\u0440\u0430\u043d\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0430.',
    t2li3: '<strong>\u0420\u0438\u0442\u043c\u044b</strong> \u2014 \u043b\u0435\u0432\u043e-\u043b\u0435\u0432\u043e-\u043f\u0440\u0430\u0432\u043e-\u043f\u0440\u0430\u0432\u043e. \u0422\u044b \u043d\u0435 \u0437\u0430\u043c\u0435\u0447\u0430\u0435\u0448\u044c, \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c \u0432\u0438\u0434\u0438\u0442.',
    t2random: '<strong>\u00ab\u0410 \u043c\u043e\u0436\u0435\u0442 \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c \u043f\u0440\u043e\u0441\u0442\u043e \u0443\u0433\u0430\u0434\u044b\u0432\u0430\u0435\u0442 \u0441\u043b\u0443\u0447\u0430\u0439\u043d\u043e?\u00bb</strong> \u041d\u0435\u0442. \u0415\u0441\u043b\u0438 \u0431\u044b \u043e\u043d \u0441\u0442\u0430\u0432\u0438\u043b \u043d\u0430\u0443\u0433\u0430\u0434, \u0442\u044b \u0431\u044b \u0432\u044b\u0438\u0433\u0440\u044b\u0432\u0430\u043b \u2014 \u044d\u043a\u043e\u043d\u043e\u043c\u0438\u043a\u0430 \u0432 \u0442\u0432\u043e\u044e \u043f\u043e\u043b\u044c\u0437\u0443 ($1.10 \u043f\u0440\u043e\u0442\u0438\u0432 $1). \u0415\u0441\u043b\u0438 \u0442\u044b \u043f\u0440\u043e\u0438\u0433\u0440\u044b\u0432\u0430\u0435\u0448\u044c \u2014 \u0437\u043d\u0430\u0447\u0438\u0442, \u043e\u043d \u0443\u0433\u0430\u0434\u044b\u0432\u0430\u0435\u0442 \u0447\u0430\u0449\u0435 52%. \u0410 \u044d\u0442\u043e \u0432\u043e\u0437\u043c\u043e\u0436\u043d\u043e \u0442\u043e\u043b\u044c\u043a\u043e \u0435\u0441\u043b\u0438 \u0442\u0432\u043e\u0438 \u043d\u0430\u0436\u0430\u0442\u0438\u044f \u043f\u0440\u0435\u0434\u0441\u043a\u0430\u0437\u0443\u0435\u043c\u044b.',
    t2p2: '<strong>\u0414\u043b\u0438\u043d\u043d\u0430\u044f \u0434\u0438\u0441\u0442\u0430\u043d\u0446\u0438\u044f.</strong> \u041d\u0430 \u0443\u0440\u043e\u0432\u043d\u0435 1 (40 \u043d\u0430\u0436\u0430\u0442\u0438\u0439) \u043c\u043e\u0436\u043d\u043e \u043f\u043e\u0432\u0435\u0437\u0442\u0438. \u041a \u0443\u0440\u043e\u0432\u043d\u044e 5 (120 \u043d\u0430\u0436\u0430\u0442\u0438\u0439) \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c \u0443\u0436\u0435 \u0437\u043d\u0430\u0435\u0442 \u0432\u0441\u0435 \u0442\u0432\u043e\u0438 \u043f\u0440\u0438\u0432\u044b\u0447\u043a\u0438. <a href="https://ru.wikipedia.org/wiki/\u0417\u0430\u043a\u043e\u043d_\u0431\u043e\u043b\u044c\u0448\u0438\u0445_\u0447\u0438\u0441\u0435\u043b" target="_blank">\u0417\u0430\u043a\u043e\u043d \u0431\u043e\u043b\u044c\u0448\u0438\u0445 \u0447\u0438\u0441\u0435\u043b</a>.',
    t2p3: '\u0418\u0434\u0435\u044e \u043f\u0440\u0438\u0434\u0443\u043c\u0430\u043b <a href="https://en.wikipedia.org/wiki/Scott_Aaronson" target="_blank">\u0421\u043a\u043e\u0442\u0442 \u0410\u0430\u0440\u043e\u043d\u0441\u043e\u043d</a>: \u043c\u043e\u0437\u0433 \u2014 \u043f\u043b\u043e\u0445\u043e\u0439 \u0433\u0435\u043d\u0435\u0440\u0430\u0442\u043e\u0440 \u0441\u043b\u0443\u0447\u0430\u0439\u043d\u044b\u0445 \u0447\u0438\u0441\u0435\u043b. \u0422\u0435 \u0436\u0435 \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c\u044b \u0440\u0430\u0431\u043e\u0442\u0430\u044e\u0442 \u0432 \u0441\u0436\u0430\u0442\u0438\u0438 \u0434\u0430\u043d\u043d\u044b\u0445 (ZIP): \u043f\u0440\u0435\u0434\u0441\u043a\u0430\u0437\u0443\u0435\u043c\u043e\u0435 = \u0441\u0436\u0438\u043c\u0430\u0435\u043c\u043e\u0435.',
    t3title: '\u041c\u0430\u0442\u0435\u043c\u0430\u0442\u0438\u043a\u0430',
    t3p1: '<a href="https://en.wikipedia.org/wiki/Prediction_by_partial_matching" target="_blank">Prediction by Partial Matching</a> \u2014 \u0430\u043d\u0441\u0430\u043c\u0431\u043b\u044c <a href="https://ru.wikipedia.org/wiki/\u0426\u0435\u043f\u044c_\u041c\u0430\u0440\u043a\u043e\u0432\u0430" target="_blank">\u043c\u0430\u0440\u043a\u043e\u0432\u0441\u043a\u0438\u0445 \u043c\u043e\u0434\u0435\u043b\u0435\u0439</a>:',
    t3formula: '\u041a\u043e\u043d\u0442\u0435\u043a\u0441\u0442 s = \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0435 k \u043d\u0430\u0436\u0430\u0442\u0438\u0439<br>C(s, 0) \u0438 C(s, 1) \u2014 \u0441\u0447\u0451\u0442\u0447\u0438\u043a\u0438<br><br>P(1|s) = (C(s,1) + 1) / (C(s,0) + C(s,1) + 2)<br><small><a href="https://ru.wikipedia.org/wiki/\u0421\u0433\u043b\u0430\u0436\u0438\u0432\u0430\u043d\u0438\u0435_\u041b\u0430\u043f\u043b\u0430\u0441\u0430" target="_blank">\u041b\u0430\u043f\u043b\u0430\u0441</a>: \u043f\u0440\u0438\u043e\u0440 Beta(1,1)</small><br><br>score += (P(1|s) \u2212 P(0|s)) \u00b7 \u221atotal \u00b7 (1 + k/2)',
    t3p2: '\u041f\u043b\u044e\u0441: \u0433\u043b\u043e\u0431\u0430\u043b\u044c\u043d\u044b\u0439 bias, \u0442\u0435\u043d\u0434\u0435\u043d\u0446\u0438\u044f \u043a \u0447\u0435\u0440\u0435\u0434\u043e\u0432\u0430\u043d\u0438\u044e, momentum \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0445 10 \u043d\u0430\u0436\u0430\u0442\u0438\u0439.',
    t3p3: '<a href="https://ru.wikipedia.org/wiki/\u0418\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u043e\u043d\u043d\u0430\u044f_\u044d\u043d\u0442\u0440\u043e\u043f\u0438\u044f" target="_blank">\u042d\u043d\u0442\u0440\u043e\u043f\u0438\u044f</a> \u0441\u043b\u0443\u0447\u0430\u0439\u043d\u043e\u0439 \u043f\u043e\u0441\u043b\u0435\u0434\u043e\u0432\u0430\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u0438 = 1 \u0431\u0438\u0442. \u0427\u0435\u043b\u043e\u0432\u0435\u0447\u0435\u0441\u043a\u0430\u044f \u2248 0.7\u20130.9 \u0431\u0438\u0442. \u0420\u0430\u0437\u043d\u0438\u0446\u0430 \u2014 \u043f\u0440\u0435\u0438\u043c\u0443\u0449\u0435\u0441\u0442\u0432\u043e \u0430\u043b\u0433\u043e\u0440\u0438\u0442\u043c\u0430.',
    langSwitch: 'EN',
  },
  en: {
    title: 'You\'re Not Random',
    subtitle: 'Try to beat the algorithm',
    rulesHTML: 'Tap <strong>left</strong> and <strong>right</strong> in a random order.<br>The algorithm predicts every tap.<br><br>It\'s right \u2014 <span class="lose">you lose $1</span><br>It\'s wrong \u2014 <span class="win">you earn $1.10</span>',
    play: 'Play',
    stop: 'Stop',
    hint: 'Desktop: arrow keys \u2190 \u2192',
    level: 'LEVEL',
    levelName: 'Level',
    won: 'You beat the algorithm!',
    wonBarely: 'Won \u2014 barely!',
    predictable70: 'Completely predictable',
    predictable60: 'The algorithm reads you',
    almost55: 'Close, but not random',
    lostSoClose: 'So close!',
    impressive50: 'Impressive!',
    incredible: 'Incredible!',
    guessed: 'Guessed',
    of: 'of',
    leftRight: 'Left/right',
    graphLabel: 'Balance over time',
    yourPresses: 'Your taps',
    predictions: 'Algorithm predictions',
    retry: 'Try again',
    replayLevel: 'Replay',
    howItWorks: 'How does it work?',
    unlocked: 'Unlocked',
    pressesWord: 'taps',
    atStart: 'start',
    allLevels: 'All levels completed!',
    allLevelsDesc: 'You beat all five levels.',
    finalBalance: 'Final balance',
    shareTitle: 'You\'re Not Random',
    gameComplete: 'You proved: you\'re random',
    provedRandom: 'You beat all 5 levels and outsmarted the algorithm.',
    theoryTitle: 'How does it work?',
    back: 'Back',
    playAgain: 'Play again',
    author: 'Demo by',
    t1title: 'Step by step',
    t1p1: 'The algorithm records every tap. After 10: <strong>L R L L R L R R L R</strong>. It searches for patterns.',
    t1ex1: '<strong>Example.</strong> You tapped "left-right" three times and each time followed with "left". The algorithm remembered. Next "left-right" \u2014 it bets "left".',
    t1p2: 'For every combination of recent taps, it counts how often "left" or "right" followed. More data = better predictions.',
    t1p3: '<strong>Multiple models run simultaneously</strong> at different depths. Level 1: up to 3 taps back. Level 2: up to 4. Level 3: up to 5. By level 5: up to 7. They all vote, consensus wins.',
    t1p4: '<strong>One continuous experiment.</strong> Your balance and algorithm memory carry across levels. Finish level 1 with $18 \u2014 you start level 2 with $18. But the algorithm remembers all your habits too.',
    t1p5: '<strong>Economy.</strong> The algorithm pays $1.10 for each miss and takes $1 for each correct guess. If you were perfectly random, you\'d profit. But it guesses right more than 52%, and that\'s enough.',
    t2title: 'Why you lose',
    t2p1: 'Humans confuse randomness with alternation. "Left-right-left-right" feels random, but real randomness includes 4\u20135 identical in a row.',
    t2li1: '<strong><a href="https://en.wikipedia.org/wiki/Gambler%27s_fallacy" target="_blank">Gambler\'s fallacy</a></strong> \u2014 after three "lefts" it feels like time for "right". A coin doesn\'t care.',
    t2li2: '<strong>Streak avoidance</strong> \u2014 4 in a row feels non-random. But in 100 flips, a streak of 4+ is almost guaranteed.',
    t2li3: '<strong>Rhythms</strong> \u2014 left-left-right-right. You don\'t notice, the algorithm does.',
    t2random: '<strong>"But isn\'t the algorithm just guessing randomly?"</strong> No. If it guessed randomly, you\'d win \u2014 the economy favors you ($1.10 vs $1). If you\'re losing, it means it\'s guessing right more than 52% of the time. That\'s only possible if your taps are predictable.',
    t2p2: '<strong>Long run.</strong> On level 1 (40 taps) you can get lucky. By level 5 (120 taps) the algorithm knows your habits. <a href="https://en.wikipedia.org/wiki/Law_of_large_numbers" target="_blank">Law of large numbers</a>.',
    t2p3: 'The idea comes from <a href="https://en.wikipedia.org/wiki/Scott_Aaronson" target="_blank">Scott Aaronson</a>: the brain is a bad random number generator. Same algorithms power data compression (ZIP): predictable = compressible.',
    t3title: 'The math',
    t3p1: '<a href="https://en.wikipedia.org/wiki/Prediction_by_partial_matching" target="_blank">Prediction by Partial Matching</a> \u2014 an ensemble of <a href="https://en.wikipedia.org/wiki/Markov_chain" target="_blank">Markov models</a>:',
    t3formula: 'Context s = last k taps<br>C(s, 0) and C(s, 1) \u2014 counters<br><br>P(1|s) = (C(s,1) + 1) / (C(s,0) + C(s,1) + 2)<br><small><a href="https://en.wikipedia.org/wiki/Additive_smoothing" target="_blank">Laplace</a>: prior Beta(1,1)</small><br><br>score += (P(1|s) \u2212 P(0|s)) \u00b7 \u221atotal \u00b7 (1 + k/2)',
    t3p2: 'Plus: global bias, alternation tendency, momentum of last 10 taps.',
    t3p3: '<a href="https://en.wikipedia.org/wiki/Entropy_(information_theory)" target="_blank">Entropy</a> of random sequence = 1 bit. Human \u2248 0.7\u20130.9 bits. The gap is the algorithm\'s edge.',
    langSwitch: 'RU',
  },
};

let currentLang = 'ru';
function T_get() { return LANG[currentLang]; }
Object.defineProperty(window, 'T', { get: T_get });

// ===== LEVELS (5 levels, increasing depth) =====
const LEVELS = [
  { id: 1, presses: 40,  balance: 15, reward: 1.10, maxK: 3, css: 'l1', stopMin: 12 },
  { id: 2, presses: 60,  balance: 15, reward: 1.10, maxK: 4, css: 'l2', stopMin: 18 },
  { id: 3, presses: 80,  balance: 15, reward: 1.10, maxK: 5, css: 'l3', stopMin: 25 },
  { id: 4, presses: 100, balance: 15, reward: 1.10, maxK: 6, css: 'l4', stopMin: 30 },
  { id: 5, presses: 120, balance: 15, reward: 1.10, maxK: 7, css: 'l5', stopMin: 40 },
];

// ===== STATE =====
const state = {
  screen: 'welcome',
  level: 0,
  maxUnlocked: 0,
  balance: 15.00,
  initialBalance: 15.00,
  carryoverBalance: null,
  checkpointBalance: null,
  balanceHistory: [],
  presses: [],
  predictions: [],
  correct: [],
  table: {},
  currentMaxK: 3,
  totalPresses: 0,
  correctPredictions: 0,
  gameOver: false,
  gameOverReason: '',
  lastPressTime: 0,
  gameStartTime: 0,
  timestamps: [],
};

const MIN_INTERVAL = 20;
const WARMUP = 3;

// ===== SCREENS =====
function showScreen(name) {
  state.screen = name;
  document.querySelectorAll('.screen').forEach(s => s.classList.toggle('active', s.id === name));
}

// ===== INIT / EXPAND TABLE =====
function initTable(maxK) {
  state.table = {};
  state.currentMaxK = maxK;
  for (let k = 1; k <= maxK; k++) {
    for (let i = 0; i < (1 << k); i++) {
      state.table[i.toString(2).padStart(k, '0')] = { 0: 0, 1: 0 };
    }
  }
}

function expandTable(newMaxK) {
  for (let k = state.currentMaxK + 1; k <= newMaxK; k++) {
    for (let i = 0; i < (1 << k); i++) {
      const key = i.toString(2).padStart(k, '0');
      if (!state.table[key]) state.table[key] = { 0: 0, 1: 0 };
    }
  }
  state.currentMaxK = newMaxK;
}

// ===== PREDICTION (ensemble) =====
function predict() {
  const n = state.presses.length;
  if (n < 1) return Math.random() < 0.5 ? 0 : 1;
  const maxK = state.currentMaxK;
  let score = 0;

  for (let k = 1; k <= maxK; k++) {
    if (n < k) continue;
    const entry = state.table[state.presses.slice(-k).join('')];
    if (!entry) continue;
    const total = entry[0] + entry[1];
    if (total === 0) continue;
    const p1 = (entry[1] + 1) / (total + 2);
    const p0 = (entry[0] + 1) / (total + 2);
    score += (p1 - p0) * Math.sqrt(total) * (1 + k * 0.5);
  }

  if (n >= 3) {
    const total1 = state.presses.reduce((a, b) => a + b, 0);
    score += ((total1 + 1) / (n + 2) - 0.5);
  }

  if (n >= 5) {
    let sw = 0;
    for (let i = 1; i < n; i++) if (state.presses[i] !== state.presses[i-1]) sw++;
    const alt = (sw / (n - 1) - 0.5) * 3;
    score += state.presses[n-1] === 1 ? -alt : alt;
  }

  if (n >= 6) {
    const w = Math.min(10, n);
    const recent = state.presses.slice(-w);
    let rsw = 0;
    for (let i = 1; i < recent.length; i++) if (recent[i] !== recent[i-1]) rsw++;
    const ralt = (rsw / (recent.length - 1) - 0.5) * 2;
    score += state.presses[n-1] === 1 ? -ralt : ralt;
  }

  if (score > 0) return 1;
  if (score < 0) return 0;
  return Math.random() < 0.5 ? 0 : 1;
}

function updateTable(actual) {
  const n = state.presses.length;
  for (let k = 1; k <= state.currentMaxK; k++) {
    if (n < k + 1) continue;
    const ctx = state.presses.slice(-(k+1), -1).join('');
    if (state.table[ctx]) state.table[ctx][actual]++;
  }
}

// ===== WATER =====
function updateWater() {
  const ratio = Math.max(0, Math.min(2, state.balance / state.initialBalance));
  const el = document.getElementById('waterBg');
  el.style.height = (Math.min(ratio, 1) * 100) + '%';
  const hue = Math.max(0, Math.min(150, ratio * 75));
  el.style.background = 'hsla(' + hue + ', 80%, 50%, 0.15)';
}

// ===== HUD =====
function updateHUD() {
  const lvl = LEVELS[state.level];
  document.getElementById('hudLevel').innerHTML = '<span class="level-badge ' + lvl.css + '">' + T.level + ' ' + lvl.id + '</span>';
  document.getElementById('hudBalance').textContent = '$' + state.balance.toFixed(2);
  document.getElementById('hudCounter').textContent = state.totalPresses + '/' + lvl.presses;
  document.getElementById('btnStop').disabled = state.totalPresses < lvl.stopMin;
}

function flashResult(wasCorrect) {
  const el = document.getElementById('hudPredResult');
  el.textContent = wasCorrect ? '\u2717' : '\u2713';
  el.className = 'hud-prediction-result show ' + (wasCorrect ? 'correct' : 'wrong');
  setTimeout(() => el.classList.remove('show'), 500);
}

// ===== RIPPLE & VIBRATE =====
function createRipple(x, y) {
  const r = document.createElement('div');
  r.className = 'ripple';
  r.style.cssText = 'width:80px;height:80px;left:' + (x-40) + 'px;top:' + (y-40) + 'px';
  document.getElementById('game').appendChild(r);
  setTimeout(() => r.remove(), 400);
}

// ===== GAME PRESS =====
let activePointerId = null;

function handlePress(choice, x, y, pointerId) {
  if (state.gameOver) return;
  if (activePointerId !== null && activePointerId !== pointerId) return;
  const now = Date.now();
  if (now - state.lastPressTime < MIN_INTERVAL) return;
  state.lastPressTime = now;

  // Track timestamp relative to game start
  state.timestamps.push(now - state.gameStartTime);

  createRipple(x, y);
  if (navigator.vibrate) navigator.vibrate(10);

  const prediction = predict();
  state.presses.push(choice);
  state.totalPresses++;
  updateTable(choice);

  if (state.totalPresses > WARMUP) {
    const hit = prediction === choice;
    state.predictions.push(prediction);
    state.correct.push(hit);
    if (hit) { state.correctPredictions++; state.balance -= 1.00; }
    else { state.balance += LEVELS[state.level].reward; }
    state.balance = Math.round(state.balance * 100) / 100;
    state.balanceHistory.push(state.balance);
    flashResult(hit);
  }

  updateWater();
  updateHUD();

  const limit = LEVELS[state.level].presses;
  if (state.totalPresses >= limit) {
    state.gameOver = true; state.gameOverReason = 'limit';
    setTimeout(showResult, 400);
  }
}

// ===== ANALYTICS =====
const SHEETS_URL = 'https://script.google.com/macros/s/AKfycbyUfEUxzWtkLG6-q4nEob-4ORS7OQTzkhQdHsX6dM9i1H5OA_NwVOKgjhKwNG2srpiz4A/exec';

function getSessionId() {
  let id = localStorage.getItem('tns_session');
  if (!id) {
    id = crypto.randomUUID ? crypto.randomUUID() :
      'xxxx-xxxx-xxxx'.replace(/x/g, () => (Math.random()*16|0).toString(16));
    localStorage.setItem('tns_session', id);
  }
  return id;
}

function getAttemptNumber() {
  let n = parseInt(localStorage.getItem('tns_attempt') || '0');
  n++;
  localStorage.setItem('tns_attempt', n.toString());
  return n;
}

function getDeviceType() {
  const ua = navigator.userAgent;
  if (/Tablet|iPad/i.test(ua)) return 'tablet';
  if (/Mobi|Android/i.test(ua)) return 'mobile';
  return 'desktop';
}

function calcMaxRun(arr) {
  if (arr.length === 0) return 0;
  let max = 1, cur = 1;
  for (let i = 1; i < arr.length; i++) {
    if (arr[i] === arr[i-1]) { cur++; if (cur > max) max = cur; }
    else cur = 1;
  }
  return max;
}

function calcTopTrigram(arr) {
  if (arr.length < 3) return '';
  const counts = {};
  for (let i = 0; i <= arr.length - 3; i++) {
    const t = arr[i] + '' + arr[i+1] + '' + arr[i+2];
    counts[t] = (counts[t] || 0) + 1;
  }
  let best = '', bestN = 0;
  for (const k in counts) {
    if (counts[k] > bestN) { best = k; bestN = counts[k]; }
  }
  return best;
}

function sendStats(d) {
  if (SHEETS_URL === 'PLACEHOLDER') return;
  try { fetch(SHEETS_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d) }).catch(()=>{}); } catch(e){}
}

// ===== BALANCE GRAPH (canvas) =====
function drawBalanceGraph(canvas, history, initial) {
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.offsetWidth * 2;
  const H = canvas.height = canvas.offsetHeight * 2;
  ctx.scale(2, 2);
  const w = W / 2, h = H / 2;

  const all = [initial, ...history];
  const maxB = Math.max(...all, initial * 1.3);
  const minB = Math.min(...all, initial * 0.3);
  const range = maxB - minB || 1;

  function yOf(v) { return h - ((v - minB) / range) * (h - 8) - 4; }
  function xOf(i) { return (i / (all.length - 1)) * w; }

  ctx.strokeStyle = '#333';
  ctx.lineWidth = 0.5;
  ctx.setLineDash([3, 3]);
  ctx.beginPath();
  ctx.moveTo(0, yOf(initial));
  ctx.lineTo(w, yOf(initial));
  ctx.stroke();
  ctx.setLineDash([]);

  for (let i = 1; i < all.length; i++) {
    const x0 = xOf(i - 1), y0 = yOf(all[i - 1]);
    const x1 = xOf(i), y1 = yOf(all[i]);
    const above = (all[i - 1] + all[i]) / 2 >= initial;

    const yBase = yOf(initial);
    ctx.beginPath();
    ctx.moveTo(x0, y0);
    ctx.lineTo(x1, y1);
    ctx.lineTo(x1, yBase);
    ctx.lineTo(x0, yBase);
    ctx.closePath();
    ctx.fillStyle = above ? 'rgba(0,255,136,0.15)' : 'rgba(255,34,68,0.12)';
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(x0, y0);
    ctx.lineTo(x1, y1);
    ctx.strokeStyle = above ? '#00ff88' : '#ff2244';
    ctx.lineWidth = 1.5;
    ctx.stroke();
  }
}

// ===== RESULT =====
function showResult() {
  const lvl = LEVELS[state.level];
  const scored = state.correct.length;
  const correctN = state.correctPredictions;
  const pct = scored > 0 ? (correctN / scored * 100) : 0;
  const won = state.balance >= state.initialBalance;
  const hasNext = state.level < LEVELS.length - 1;

  // Context-aware result messages
  let title = '';
  if (won) {
    if (pct < 48) title = T.incredible;
    else if (pct < 52) title = T.won;
    else title = T.wonBarely;
  } else {
    if (pct >= 65) title = T.predictable70;
    else if (pct >= 58) title = T.predictable60;
    else if (pct >= 53) title = T.almost55;
    else title = T.lostSoClose;
  }

  if (won && hasNext && state.level + 1 > state.maxUnlocked) state.maxUnlocked = state.level + 1;

  // Save checkpoint when player wins
  if (won) {
    state.checkpointBalance = state.balance;
  }

  // Use only current level's presses for display
  const levelPresses = state.totalPresses > 0 ? state.presses.slice(-state.totalPresses) : [];
  const count0 = levelPresses.filter(p => p === 0).length;
  const count1 = levelPresses.length - count0;

  const balColor = state.balance >= state.initialBalance ? '#00ff88' : '#ff2244';

  const cellSize = levelPresses.length > 200 ? 4 : 6;
  const cs = ';width:' + cellSize + 'px;height:' + cellSize + 'px';

  let pressMap = '';
  levelPresses.forEach(p => {
    pressMap += '<div class="cell" style="background:' + (p===0?'#333':'#aaa') + cs + '"></div>';
  });
  let predMap = '';
  const warmup = state.totalPresses - state.correct.length;
  for (let i = 0; i < warmup; i++) predMap += '<div class="cell" style="background:#1a1a1a' + cs + '"></div>';
  state.correct.forEach(c => {
    predMap += '<div class="cell" style="background:' + (c?'#ff2244':'#00ff88') + cs + '"></div>';
  });

  const isEndgame = won && !hasNext;
  const authorHTML = '<div class="result-author">' + T.author + ': <a href="https://www.facebook.com/teo.spiro.2025" target="_blank">Teo Spiro</a></div>';

  let btns = '';
  if (won && hasNext) {
    const nx = LEVELS[state.level + 1];
    const isLast = state.level + 1 === LEVELS.length - 1;
    btns = '<button class="btn-next-level' + (isLast ? ' final' : '') + '" id="btnNextLevel">' + T.levelName + ' ' + nx.id + ' &rarr;</button><button class="btn-secondary" id="btnRetry">' + T.replayLevel + '</button>';
  } else {
    btns = '<button class="btn-primary" id="btnRetry">' + T.retry + '</button>';
  }

  if (isEndgame) {
    // ===== ENDGAME: won all 5 levels =====
    document.getElementById('result').innerHTML =
      '<div class="endgame-card fade-item" style="animation-delay:0ms">' +
        '<div class="endgame-title">' + T.shareTitle + '</div>' +
        '<div class="endgame-badge">\u2605 ' + T.level + ' 1\u20135 \u2605</div>' +
        '<div class="endgame-message">' + T.gameComplete + '</div>' +
        '<div class="endgame-sub">' + T.provedRandom + '</div>' +
        '<div class="endgame-balance">$' + state.balance.toFixed(2) + '</div>' +
        '<div class="result-stats" style="text-align:center">' +
          T.guessed + ': <span>' + correctN + ' ' + T.of + ' ' + scored + ' (' + pct.toFixed(0) + '%)</span>' +
        '</div>' +
        authorHTML +
      '</div>' +
      '<div class="balance-graph-container fade-item" style="animation-delay:150ms">' +
        '<div class="balance-graph-label">' + T.graphLabel + '</div>' +
        '<canvas class="balance-graph" id="balGraph"></canvas>' +
      '</div>' +
      '<div class="pattern-map-container fade-item" style="animation-delay:230ms">' +
        '<div class="pattern-map-label">' + T.yourPresses + '</div>' +
        '<div class="pattern-map">' + pressMap + '</div>' +
        '<div class="pattern-map-label" style="margin-top:0.4rem">' + T.predictions + '</div>' +
        '<div class="pattern-map">' + predMap + '</div>' +
      '</div>' +
      '<div class="result-buttons fade-item" style="animation-delay:310ms">' +
        '<button class="btn-primary" id="btnRetry">' + T.retry + '</button>' +
        '<button class="btn-secondary" id="btnTheory">' + T.howItWorks + '</button>' +
      '</div>';
  } else {
    // ===== NORMAL RESULT: card layout =====
    let levelUpHTML = '';
    if (won && hasNext) {
      const nx = LEVELS[state.level + 1];
      levelUpHTML = '<div class="result-level-up fade-item" style="animation-delay:350ms"><div class="level-up-title">' + T.unlocked + ' ' + T.levelName + ' ' + nx.id + '!</div><div class="level-up-desc">' + nx.presses + ' ' + T.pressesWord + ', $' + state.balance.toFixed(2) + ' ' + T.atStart + '</div></div>';
    }

    document.getElementById('result').innerHTML =
      '<div class="result-card fade-item" style="animation-delay:0ms">' +
        '<div class="result-card-title">' + T.shareTitle + '</div>' +
        '<span class="result-level-badge-big ' + lvl.css + '">' + T.level + ' ' + lvl.id + '</span>' +
        '<h2 style="font-size:1.3rem;line-height:1.3">' + title + '</h2>' +
        '<div class="result-balance-big" style="color:' + balColor + '">$' + state.balance.toFixed(2) + '</div>' +
        '<div class="result-stats">' +
          T.guessed + ': <span>' + correctN + ' ' + T.of + ' ' + scored + ' (' + pct.toFixed(0) + '%)</span><br>' +
          T.leftRight + ': <span>' + count0 + '/' + count1 + '</span>' +
        '</div>' +
        authorHTML +
      '</div>' +
      '<div class="balance-graph-container fade-item" style="animation-delay:150ms">' +
        '<div class="balance-graph-label">' + T.graphLabel + '</div>' +
        '<canvas class="balance-graph" id="balGraph"></canvas>' +
      '</div>' +
      '<div class="pattern-map-container fade-item" style="animation-delay:230ms">' +
        '<div class="pattern-map-label">' + T.yourPresses + '</div>' +
        '<div class="pattern-map">' + pressMap + '</div>' +
        '<div class="pattern-map-label" style="margin-top:0.4rem">' + T.predictions + '</div>' +
        '<div class="pattern-map">' + predMap + '</div>' +
      '</div>' +
      levelUpHTML +
      '<div class="result-buttons fade-item" style="animation-delay:380ms">' + btns +
        '<button class="btn-secondary" id="btnTheory">' + T.howItWorks + '</button>' +
      '</div>';
  }

  document.getElementById('btnRetry').addEventListener('click', () => startGame(state.level));
  const nextBtn = document.getElementById('btnNextLevel');
  if (nextBtn) nextBtn.addEventListener('click', () => startGame(state.level + 1));
  document.getElementById('btnTheory').addEventListener('click', showTheory);

  showScreen('result');

  requestAnimationFrame(() => {
    const canvas = document.getElementById('balGraph');
    if (canvas && state.balanceHistory.length > 1) drawBalanceGraph(canvas, state.balanceHistory, state.initialBalance);
  });

  // Enhanced analytics
  const accLast10 = state.correct.length >= 10 ? +(state.correct.slice(-10).filter(Boolean).length / 10 * 100).toFixed(1) : '';
  const accLast20 = state.correct.length >= 20 ? +(state.correct.slice(-20).filter(Boolean).length / 20 * 100).toFixed(1) : '';

  sendStats({
    sessionId: getSessionId(),
    attemptNumber: getAttemptNumber(),
    level: lvl.id,
    totalPresses: state.totalPresses,
    correctPredictions: correctN,
    accuracy: +pct.toFixed(1),
    balance: state.balance,
    won: won,
    reason: state.gameOverReason,
    ratio01: count0 + '/' + count1,
    maxRun: calcMaxRun(levelPresses),
    topTrigram: calcTopTrigram(levelPresses),
    sequence: levelPresses.join(''),
    timestamps: state.timestamps.join(','),
    accLast10: accLast10,
    accLast20: accLast20,
    carryoverBalance: state.carryoverBalance,
    device: getDeviceType(),
    lang: currentLang,
    userAgent: navigator.userAgent,
  });
}

// ===== THEORY =====
function showTheory() {
  document.getElementById('theory').innerHTML =
    '<div class="theory-header"><h2>' + T.theoryTitle + '</h2><button class="btn-back" id="btnBackResult">&larr; ' + T.back + '</button></div>' +
    '<div class="theory-body" id="theoryBody">' +

    '<p class="theory-section-title">' + T.t1title + '</p>' +
    '<p>' + T.t1p1 + '</p>' +
    '<div class="example-box">' + T.t1ex1 + '</div>' +
    '<p>' + T.t1p2 + '</p>' +
    '<p>' + T.t1p3 + '</p>' +
    '<p>' + T.t1p4 + '</p>' +
    '<p>' + T.t1p5 + '</p>' +

    '<div style="text-align:center"><button class="btn-primary theory-play-btn" id="btnPlay1">' + T.playAgain + '</button></div>' +

    '<hr class="theory-divider">' +
    '<p class="theory-section-title">' + T.t2title + '</p>' +
    '<p>' + T.t2p1 + '</p>' +
    '<ul>' +
    '<li>' + T.t2li1 + '</li>' +
    '<li>' + T.t2li2 + '</li>' +
    '<li>' + T.t2li3 + '</li>' +
    '</ul>' +
    '<div class="example-box">' + T.t2random + '</div>' +
    '<p>' + T.t2p2 + '</p>' +
    '<p>' + T.t2p3 + '</p>' +

    '<hr class="theory-divider">' +
    '<p class="theory-section-title">' + T.t3title + '</p>' +
    '<p>' + T.t3p1 + '</p>' +
    '<div class="formula">' + T.t3formula + '</div>' +
    '<p>' + T.t3p2 + '</p>' +
    '<p>' + T.t3p3 + '</p>' +

    '<div style="text-align:center"><button class="btn-primary theory-play-btn" id="btnPlay2">' + T.playAgain + '</button></div>' +

    '<div class="author-link">' + T.author + ': <a href="https://www.facebook.com/teo.spiro.2025" target="_blank">Teo Spiro</a></div>' +
    '</div>';

  document.getElementById('btnBackResult').addEventListener('click', () => showScreen('result'));
  document.getElementById('btnPlay1').addEventListener('click', () => startGame(state.level));
  document.getElementById('btnPlay2').addEventListener('click', () => startGame(state.level));

  showScreen('theory');
}

// ===== START GAME =====
function startGame(levelIndex) {
  const prevLevel = state.level;
  state.level = levelIndex || 0;
  const lvl = LEVELS[state.level];

  // Algorithm memory (presses + table) persists for the ENTIRE session.
  // Only balance resets on replay; it carries over when advancing.
  if (Object.keys(state.table).length === 0) {
    // Very first game of session: init table
    initTable(lvl.maxK);
  } else if (lvl.maxK > state.currentMaxK) {
    // Need higher depth: expand, keep all existing data
    expandTable(lvl.maxK);
  }
  // state.presses is NEVER reset — algorithm remembers everything

  // Balance: carry over when advancing, reset when replaying
  if (levelIndex > prevLevel && levelIndex > 0 && state.presses.length > 0) {
    state.carryoverBalance = state.balance;
    state.initialBalance = state.balance;
    state.balanceHistory = [state.balance];
  } else {
    // Replay or fresh start: use checkpoint if available
    const startBalance = state.checkpointBalance !== null ? state.checkpointBalance : lvl.balance;
    state.balance = startBalance;
    state.initialBalance = startBalance;
    state.balanceHistory = [startBalance];
    state.carryoverBalance = state.checkpointBalance !== null ? state.checkpointBalance : null;
  }

  state.predictions = [];
  state.correct = [];
  state.totalPresses = 0;
  state.correctPredictions = 0;
  state.gameOver = false;
  state.gameOverReason = '';
  state.lastPressTime = 0;
  state.gameStartTime = Date.now();
  state.timestamps = [];
  updateWater();
  updateHUD();
  document.getElementById('hudPredResult').className = 'hud-prediction-result';
  document.getElementById('hudPredResult').textContent = '';
  showScreen('game');
}

// ===== EVENTS =====
document.getElementById('btnStart').addEventListener('click', () => startGame(0));

document.getElementById('game').addEventListener('pointerdown', (e) => {
  if (state.screen !== 'game' || state.gameOver) return;
  if (e.target.closest('.btn-stop')) return;
  activePointerId = e.pointerId;
  const rect = document.getElementById('game').getBoundingClientRect();
  handlePress(e.clientX < window.innerWidth / 2 ? 0 : 1, e.clientX - rect.left, e.clientY - rect.top, e.pointerId);
});

document.getElementById('game').addEventListener('pointerup', (e) => {
  if (e.pointerId === activePointerId) activePointerId = null;
});
document.getElementById('game').addEventListener('pointercancel', (e) => {
  if (e.pointerId === activePointerId) activePointerId = null;
});

document.getElementById('btnStop').addEventListener('click', () => {
  const lvl = LEVELS[state.level];
  if (state.totalPresses >= lvl.stopMin && !state.gameOver) {
    state.gameOver = true; state.gameOverReason = 'manual'; showResult();
  }
});

// ===== KEYBOARD (arrows) =====
document.addEventListener('keydown', (e) => {
  if (state.screen !== 'game' || state.gameOver) return;
  let choice = -1;
  if (e.key === 'ArrowLeft') choice = 0;
  else if (e.key === 'ArrowRight') choice = 1;
  if (choice < 0) return;
  e.preventDefault();
  const cx = choice === 0 ? window.innerWidth * 0.25 : window.innerWidth * 0.75;
  const cy = window.innerHeight * 0.5;
  handlePress(choice, cx, cy, 'keyboard');
});

// ===== LANGUAGE =====
function updateAllText() {
  document.getElementById('welTitle').textContent = T.title;
  document.getElementById('welSubtitle').textContent = T.subtitle;
  document.getElementById('welRules').innerHTML = T.rulesHTML;
  document.getElementById('btnStart').textContent = T.play;
  document.getElementById('btnLang').textContent = T.langSwitch;
  document.getElementById('btnStop').textContent = T.stop;
  document.getElementById('welHint').textContent = T.hint;
  document.getElementById('welFooter').innerHTML = T.author + ': <a href="https://www.facebook.com/teo.spiro.2025" target="_blank">Teo Spiro</a>';
  document.title = T.title;
}
updateAllText();

document.getElementById('btnLang').addEventListener('click', () => {
  currentLang = currentLang === 'ru' ? 'en' : 'ru';
  updateAllText();
});

try { if (screen.orientation && screen.orientation.lock) screen.orientation.lock('portrait').catch(()=>{}); } catch(e){}
</script>
</body>
</html>
